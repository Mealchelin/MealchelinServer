<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
	
<mapper namespace="com.mealchelin.mvc.review.model.mapper.ReviewMapper">
	<sql id="reviewListSql">
		SELECT	REVIEW_NO,
				RATED,
				NAME,
				CONTENT,
				IMAGE,
				RGSTR_DATE,
				VIEWS,
				STATUS,
				USER_NO,
				PRD_NO
        FROM REVIEW
	</sql>

	<resultMap id="reviewListResultMap" type="Review">
		<id property="reviewNo" column="REVIEW_NO"/>
		<result property="rated" column="RATED"/>
		<result property="name" column="NAME"/>
		<result property="content" column="CONTENT"/>
		<result property="image" column="IMAGE"/>
		<result property="rgstrDate" column="RGSTR_DATE"/>
		<result property="views" column="VIEWS"/>
		<result property="status" column="STATUS"/>
		<result property="userNo" column="USER_NO"/>
		<result property="prdNo" column="PRD_NO"/>
		<result property="id" column="ID"/>
	</resultMap>
	


	<!-- 게시글 등록 -->
	<insert id="insertReview" parameterType="Review"
		useGeneratedKeys="true" keyProperty="reviewNo" keyColumn="REVIEW_NO">
		INSERT INTO REVIEW (
			REVIEW_NO,
			RATED,
			NAME,
			CONTENT,
			RGSTR_DATE,
			IMAGE,
			USER_NO
		) VALUES(
			SEQ_REVIEW_NO.NEXTVAL,
			#{rated},
			#{name},
			#{content},
            SYSDATE,
			#{image},
			#{userNo}
			
		)
	</insert>
	
	
	<!-- 게시글 목록 조회(회원 번호에 따라서) -->
	<select id="getReviewCountByuserNo" resultType="_int" parameterType="_int">
		SELECT COUNT(*) 
		FROM REVIEW 
		WHERE STATUS='Y' AND USER_NO = #{userNo}
	</select>

	<!-- 게시글 목록 조회(전체 목록) -->
	<select id="getReviewCount" resultType="_int">
		SELECT COUNT(*) 
		FROM REVIEW 
		WHERE STATUS='Y'
	</select>

	<select id="selectAll" resultMap="reviewListResultMap">
		SELECT	REVIEW.REVIEW_NO,
				REVIEW.RATED,
				REVIEW.NAME,
				REVIEW.CONTENT,
				REVIEW.IMAGE,
				REVIEW.RGSTR_DATE,
				REVIEW.VIEWS,
				REVIEW.STATUS,
				REVIEW.USER_NO,
				REVIEW.PRD_NO,
                MEMBER.ID
        FROM REVIEW
		LEFT JOIN MEMBER ON REVIEW.USER_NO = MEMBER.MEMBER_NO
		WHERE REVIEW.STATUS = 'Y'
		ORDER BY REVIEW_NO DESC
	</select>
	
	<select id="selectAllByuserNo" resultMap="reviewListResultMap" parameterType="_int">
		<include refid="reviewListSql" />
		WHERE STATUS = 'Y' AND USER_NO = #{userNo}
        ORDER BY REVIEW_NO DESC
	</select>

	<!-- 리뷰 상세 보기 -->
	<select id="selectReviewByNo" parameterType="_int"
		resultMap="reviewListResultMap">
		SELECT REVIEW_NO,
		       RATED, 
		       NAME, 
		       CONTENT,
		       IMAGE,
		       RGSTR_DATE,
		       VIEWS,
		       STATUS,
		       USER_NO,
		       PRD_NO
		FROM REVIEW
		WHERE REVIEW_NO = #{reviewNo}
	</select>

	<!-- 게시글 삭제 -->
	<update id="delete" parameterType="map">
		UPDATE REVIEW
		SET
			STATUS = #{status}  
		WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	<update id="updateReview" parameterType="Review">
		UPDATE REVIEW
		SET
			RATED = #{rated},
			NAME = #{name},
			CONTENT = #{content},
			IMAGE = #{image},
			RGSTR_DATE = SYSDATE
		WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	<update id="updateReviewNoImgChage" parameterType="Review">
		UPDATE REVIEW
		SET
			RATED = #{rated},
			NAME = #{name},
			CONTENT = #{content},
			RGSTR_DATE = SYSDATE
		WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	<update id="updateStatus">
    UPDATE review
    SET status = N
    WHERE review_no IN
    <foreach collection="checkedReviewNoList" item="reviewNo" open="(" separator="," close=")">
      #{reviewNo}
    </foreach>
	</update>

</mapper>	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	